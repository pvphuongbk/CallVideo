@{
    ViewData["Title"] = "Voice Call";
}

<h2>Voice Call</h2>

<select id="userList"></select>
<button id="callButton">Voice Call</button>
<div id="callNotification" style="display:none; background:yellow; padding:10px; margin-top:10px;"></div>

<br />
<br />

<video id="localVideo" autoplay playsinline muted style="width: 400px; border: 1px solid black;"></video>
<video id="remoteVideo" autoplay playsinline style="width: 400px; border: 1px solid black;"></video>
<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
<script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>

<script>


    const connection = new signalR.HubConnectionBuilder().withUrl("/videoCallHub").build();
    let myConnectionId = '';
    let localStream;
    let peerConnection;
    let targetConnectionId = '';
    let userList = [];
    const configuration = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

    // Kết nối SignalR
    connection.start().then(() => {
        console.log("SignalR connected.");
        startLocalStream();
    }).catch(function (err) {
        return console.error(err.toString());
    });

    // Nhận ID của mình
    connection.on("ReceiveYourId", function (connectionId) {
        myConnectionId = connectionId;
    });

    // Khi user mới kết nối
    connection.on("UserConnected", function (userId) {
        console.log("User connected: " + userId);
        if (userId === myConnectionId) return; // Không thêm chính mình
        let userList = document.getElementById("userList");
        let option = document.createElement("option");
        option.value = userId;
        option.text = userId;
        userList.appendChild(option);
    });

    // Khi user nhận được danh sách user online
    connection.on("ReceiveUserList", function (userList) {
        let userSelect = document.getElementById("userList");
        userSelect.innerHTML = '';

        userList.forEach(function (userId) {
            if (userId !== myConnectionId) {
                let option = document.createElement("option");
                option.value = userId;
                option.text = userId;
                userSelect.appendChild(option);
            }
        });
    });

    // Khi user ngắt kết nối
    connection.on("UserDisconnected", function (userId) {
        let userSelect = document.getElementById("userList");
        for (let i = 0; i < userSelect.options.length; i++) {
            if (userSelect.options[i].value === userId) {
                userSelect.remove(i);
                break;
            }
        }
    });

    connection.on("ReceiveCall", function (fromConnectionId) {
        const callNotification = document.getElementById("callNotification");
        callNotification.innerHTML = `Cuộc gọi đến từ: ${fromConnectionId} <button onclick="acceptCall('${fromConnectionId}')">Chấp nhận</button>`;
        callNotification.style.display = "block";
    });

    connection.on("CallAccepted", async (toConnectionId) => {
        if (!localStream) await startLocalStream();
        createPeerConnection();

        const offer = await peerConnection.createOffer();
        await peerConnection.setLocalDescription(offer);
        connection.invoke("SendOffer", toConnectionId, JSON.stringify(offer));
    });

    connection.on("ReceiveOffer", async (fromConnectionId, offer) => {
        targetConnectionId = fromConnectionId;
        await startLocalStream();
        createPeerConnection();

        await peerConnection.setRemoteDescription(new RTCSessionDescription(JSON.parse(offer)));
        const answer = await peerConnection.createAnswer();
        await peerConnection.setLocalDescription(answer);

        connection.invoke("SendAnswer", targetConnectionId, JSON.stringify(answer));
    });

    // Khi nhận được answer
    connection.on("ReceiveAnswer", async (fromConnectionId, answer) => {
        await peerConnection.setRemoteDescription(new RTCSessionDescription(JSON.parse(answer)));
    });

    // Khi nhận được ICE Candidate
    connection.on("ReceiveIceCandidate", async (fromConnectionId, candidate) => {
        if (peerConnection) {
            await peerConnection.addIceCandidate(new RTCIceCandidate(JSON.parse(candidate)));
        }
    });

    // Sự kiện click nút Call
    document.getElementById("callButton").addEventListener("click", async () => {
        targetConnectionId = document.getElementById("userList").value;
        if (!targetConnectionId) {
            alert('Vui lòng chọn người muốn gọi.');
            return;
        }

        if (!localStream) {
            alert('Không tìm thấy camera/micro. Vui lòng kiểm tra thiết bị.');
            return;
        }

        connection.invoke("CallUser", targetConnectionId);
    });

    async function acceptCall(fromConnectionId) {
        document.getElementById("callNotification").style.display = "none";
        targetConnectionId = fromConnectionId;
        await connection.invoke("AcceptCall", fromConnectionId);
    }

    // Mở camera/micro
    async function startLocalStream() {
        try {
            localStream = await navigator.mediaDevices.getUserMedia({ video: false, audio: true });
            document.getElementById('localVideo').srcObject = localStream;
        } catch (error) {
            console.error('Không thể truy cập camera/micro:', error);
            alert('Không thể truy cập camera/micro. Vui lòng kiểm tra thiết bị hoặc cấp quyền.');
        }
    }

    // Tạo peer connection
    function createPeerConnection() {
        if (!localStream) {
            alert('Camera chưa được bật hoặc không truy cập được.');
            return;
        }

        peerConnection = new RTCPeerConnection(configuration);

        localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

        peerConnection.ontrack = event => {
            document.getElementById('remoteVideo').srcObject = event.streams[0];
        };

        peerConnection.onicecandidate = event => {
            if (event.candidate) {
                connection.invoke("SendIceCandidate", targetConnectionId, JSON.stringify(event.candidate));
            }
        };
    }

</script>